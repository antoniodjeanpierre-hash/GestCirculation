@page
@model GestCirculation.Pages_Contraventions.IndexModel

@{
    ViewData["Title"] = "Index";
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/IndexConduc.css" />

<div class="container fade-in">
    <h1 class="text-center my-4 text-primary fw-bold title-animate">Liste des Contraventions</h1>

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <a class="btn btn-success mb-2" asp-page="Create">
            <i class="fas fa-plus"></i> Ajouter Nouveau
        </a>

        <div class="d-flex gap-2 mb-2">
            <button id="exportExcel" class="btn btn-primary">
                <i class="fas fa-file-excel"></i> Exporter Excel
            </button>
            <button id="exportPDF" class="btn btn-danger">
                <i class="fas fa-file-pdf"></i> Exporter PDF
            </button>
        </div>
    </div>
<div class="mb-4">
    <h5 class="mb-2 text-secondary">
        <i class="fas fa-search me-2 text-primary"></i>
        Rechercher par le nom de l'agent ou du conducteur
    </h5>
    <div class="position-relative" style="max-width: 400px;">
        <input type="text" id="searchInput" class="form-control shadow-sm ps-5 rounded-pill border-0" placeholder="Tapez un nom ici..." />
        <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y text-muted ms-3"></i>
    </div>
</div>

    <div class="table-container">
        <table id="contraventionTable" class="table table-striped table-hover shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th><i class="fas fa-hashtag me-1 text-primary"></i>ID</th>
                    <th><i class="fas fa-car me-1 text-info"></i>Plaque</th>
                    <th><i class="fas fa-palette me-1 text-warning"></i>Couleur</th>
                    <th><i class="fas fa-industry me-1 text-success"></i>Marque</th>
                    <th><i class="fas fa-map-marker-alt me-1 text-danger"></i>Adresse</th>
                    <th><i class="fas fa-scroll me-1 text-secondary"></i>Article</th>
                    <th><i class="fas fa-calendar-day me-1 text-primary"></i>Date</th>
                    <th><i class="fas fa-user-tie me-1 text-info"></i>Conducteur</th>
                    <th><i class="fas fa-user-shield me-1 text-success"></i>Agent</th>
                    <th><i class="fas fa-cogs me-2 text-muted"></i>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Contravention != null && Model.Contravention.Any())
                {
                    foreach (var item in Model.Contravention)
                    {
                        <tr>
                            <td>@item.Id</td>
                            <td>@item.Plaque_vehicule</td>
                            <td>@item.Couleur</td>
                            <td>@item.Marque</td>
                            <td>@item.Adresse</td>
                            <td>@item.Article_violation</td>
                            <td>@item.Date_contravention.ToString("dd/MM/yyyy")</td>
                            <td>@($"{item.Conducteur?.Nom} {item.Conducteur?.Prenom}")</td>
                            <td>@($"{item.Agent?.Nom} {item.Agent?.Prenom}")</td>
                            <td>
                                <a class="btn btn-info btn-sm me-1" asp-page="./Edit" asp-route-id="@item.Id">
                                    <i class="fas fa-edit me-1"></i>
                                </a>
                                <a class="btn btn-danger btn-sm" asp-page="./Delete" asp-route-id="@item.Id">
                                    <i class="fas fa-trash-alt me-1"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="10" class="text-center text-muted">Aucune contravention trouvée</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<script>
        document.getElementById("searchInput").addEventListener("keyup", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#contraventionTable tbody tr");

        rows.forEach(row => {
            const conducteur = row.cells[7]?.textContent.toLowerCase() || "";
            const agent = row.cells[8]?.textContent.toLowerCase() || "";

            if (conducteur.includes(filter) || agent.includes(filter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });

    document.getElementById('exportExcel').addEventListener('click', () => {
    let table = document.getElementById('contraventionTable'); // ID de ta table
    let wb = XLSX.utils.table_to_book(table, {sheet:"Contraventions"});
    XLSX.writeFile(wb, "Contraventions.xlsx");
});

 document.getElementById('exportPDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    var doc = new jsPDF();

    doc.autoTable({ 
        html: '#contraventionTable', 
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] },
        alternateRowStyles: { fillColor: [220, 230, 241] }
    });
    doc.save('Contraventions.pdf');
});
</script>

    <div class="text-center mt-5">
        <img src="~/image/logopolice.png" alt="Logo PNH" class="logo-pnh" />
    </div>
</div>

<style>
    .table-container {
    width: 100%;
    overflow-x: hidden; /* supprime scroll horizontal */
}

#contraventionTable {
    table-layout: fixed; /* colonnes équilibrées */
    width: 100%;
    font-size: 0.95rem;
}

#contraventionTable th,
#contraventionTable td {
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Colonnes longues autorisées à se wrap */
#contraventionTable td:nth-child(5),
#contraventionTable td:nth-child(6) {
    white-space: normal;
    word-wrap: break-word;
}

/* Effet hover amélioré */
#contraventionTable tbody tr:hover {
    background-color: #f0f8ff;
    transform: scale(1.01);
    transition: all 0.2s ease-in-out;
}
</style>
